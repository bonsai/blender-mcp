# V3 要求定義 - 子供向け3Dプリンター・レゴ設計システム

## 🎯 ビジョン

**「子供がブラウザで話しかけるだけで、3Dプリンター用のレゴ部品を設計・出力できるシステム」**

```
子供のブラウザ (Chrome / Safari)
    ↓ (自然言語入力)
Flask Web Server (HTML/CSS/JS)
    ↓ (REST API)
Session Manager (Python)
    ↓ (Tool Call)
Blender MCP
    ↓ (3D生成)
Blender + 3Dプリンター出力
    ↓ (オプション)
発注フロー (Go + JSONL)
```

---

## 📋 要求事項

### 1. Flask Web UI（入力層）

**ユーザーストーリー**
- 子供がブラウザで簡単に話しかけられる
- チャット履歴が見える
- 3D プレビューが見える
- STLファイルをダウンロード可能

**受け入れ基準**
1. WHEN 子供がテキストを入力 THEN システムが理解して3D化する
2. WHEN チャット履歴を見る THEN 過去の会話と3D結果が表示される
3. WHEN 3Dプレビューをクリック THEN 回転・拡大できる
4. WHEN "ダウンロード" ボタンをクリック THEN STLファイルがダウンロードできる
5. WHEN "発注する" ボタンをクリック THEN 発注フローに進める（オプション）

**技術仕様**
- フレームワーク: Flask (Python)
- フロントエンド: HTML5 + CSS3 + Vanilla JavaScript
- 3D表示: Three.js / Babylon.js
- 通信: REST API (JSON)
- ストレージ: ブラウザ LocalStorage + サーバー JSONL

---

### 2. Flask Web Server（ビジネスロジック層）

**ユーザーストーリー**
- ブラウザからのリクエストを処理
- セッション管理を引き継ぐ
- チャット履歴を JSONL で保存
- 3D生成を指示

**受け入れ基準**
1. WHEN POST /api/chat THEN セッションIDで会話を管理する
2. WHEN GET /api/history/{session_id} THEN チャット履歴をJSON形式で返す
3. WHEN POST /api/generate THEN Blenderに3D生成を指示する
4. WHEN GET /api/preview/{session_id} THEN 3Dプレビュー画像を返す
5. WHEN POST /api/order THEN 発注フローを開始する（オプション）

**技術仕様**
- フレームワーク: Flask (Python)
- API形式: REST (JSON)
- データベース: 素の JSONL ファイル
- 処理: Go で高速化（オプション）
- キャッシュ: メモリ内キャッシュ

---

### 3. チャット履歴管理（JSONL形式）

**ユーザーストーリー**
- 全ての会話を JSONL で記憶
- Go で高速処理
- ML学習用に構造化
- 検索・フィルタリング可能

**受け入れ基準**
1. WHEN チャットが送信される THEN JSONL形式で保存される
2. WHEN 履歴を検索 THEN Go で高速検索できる
3. WHEN データをエクスポート THEN JSONL形式で出力できる
4. WHEN ML学習 THEN 正規化されたデータが使える

**データ形式（JSONL）**

```jsonl
{"session_id":"lego-20260106-101530-a1b2c3d4","timestamp":"2026-01-06T10:15:30Z","role":"user","content":"赤いレゴの家を作って","intent":"create_lego_house","entities":{"color":"red","object":"house"}}
{"session_id":"lego-20260106-101530-a1b2c3d4","timestamp":"2026-01-06T10:15:35Z","role":"assistant","content":"赤いレゴの家を作りました！","model_id":"lego-house-001","preview_url":"/preview/lego-house-001.png","stl_url":"/models/lego-house-001.stl"}
```

**Go 処理**
- JSONL ファイルの読み込み・書き込み
- 高速検索・フィルタリング
- データ正規化・クリーニング
- バッチ処理

---

### 4. 3Dプリンター連携

**ユーザーストーリー**
- レゴ互換部品を設計
- STL形式で出力
- サイズ・色を指定可能

**受け入れ基準**
1. WHEN "出力" をクリック THEN STLファイルが生成される
2. WHEN サイズを指定 THEN 3Dプリンター対応サイズに調整される
3. WHEN 色を指定 THEN マテリアル情報が含まれる
4. WHEN 複数部品 THEN 分割出力できる

**技術仕様**
- 出力形式: STL / GCODE
- レゴ互換性: 標準ブロック寸法準拠
- マテリアル: PLA / PETG / ABS
- 最大サイズ: 200mm × 200mm × 200mm

---

### 5. 発注フロー（オプション）

**ユーザーストーリー**
- 子供が "発注する" をクリック
- 親に通知が行く
- 3Dプリンター業者に自動発注（オプション）
- 進捗を追跡

**受け入れ基準**
1. WHEN "発注する" をクリック THEN 発注フローが開始される
2. WHEN 親が承認 THEN 3Dプリンター業者に送信される
3. WHEN 進捗を確認 THEN ステータスが表示される
4. WHEN 完成 THEN 配送情報が表示される

**技術仕様**
- フロー管理: Go + JSONL
- 通知: メール / SMS
- 決済: Stripe / PayPal（オプション）
- 追跡: API連携

---

### 6. ML学習用データ形式

**ユーザーストーリー**
- チャット履歴がML学習に使える
- 正規化・クリーニング済み
- バージョン管理可能

**受け入れ基準**
1. WHEN データをエクスポート THEN JSONL形式で出力される
2. WHEN 学習データセット作成 THEN 自動分割される
3. WHEN データクリーニング THEN 異常値が除去される
4. WHEN バージョン管理 THEN タイムスタンプ付きで保存される

**データ形式（JSONL）**

```jsonl
{"session_id": "lego-001", "user_input": "赤いレゴの家", "intent": "create_lego_house", "entities": {"color": "red", "object": "house"}, "success": true}
{"session_id": "lego-001", "user_input": "もっと大きく", "intent": "modify_size", "entities": {"size": "large"}, "success": true}
{"session_id": "lego-002", "user_input": "青い車", "intent": "create_lego_car", "entities": {"color": "blue", "object": "car"}, "success": true}
```

---

## 🏗️ システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│ ブラウザ (Chrome / Safari / Firefox)                    │
│ - チャット入力                                          │
│ - 履歴表示                                              │
│ - 3Dプレビュー (Three.js)                               │
│ - STLダウンロード                                       │
│ - 発注フロー（オプション）                              │
└────────────────┬────────────────────────────────────────┘
                 │ REST API (JSON)
                 ▼
┌─────────────────────────────────────────────────────────┐
│ Flask Web Server (Python)                               │
│ - HTML/CSS/JS 配信                                      │
│ - API エンドポイント                                    │
│ - チャット処理                                          │
│ - セッション管理                                        │
│ - JSONL 読み書き                                        │
└────────────────┬────────────────────────────────────────┘
                 │ Python Interface
                 ▼
┌─────────────────────────────────────────────────────────┐
│ Session Manager (Python)                                │
│ - セッション状態管理                                    │
│ - Blender 接続                                          │
│ - コマンドルーティング                                  │
└────────────────┬────────────────────────────────────────┘
                 │ Socket / JSON
                 ▼
┌─────────────────────────────────────────────────────────┐
│ Blender MCP (Python)                                    │
│ - 3D生成                                                │
│ - STL出力                                               │
│ - プレビュー生成                                        │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ Go 処理エンジン（オプション）                            │
│ - JSONL 高速処理                                        │
│ - データ検索・フィルタリング                            │
│ - 発注フロー管理                                        │
│ - バッチ処理                                            │
└─────────────────────────────────────────────────────────┘
```

---

## 📊 データフロー

### チャット送信フロー

```
1. 子供: "赤いレゴの家を作って"
   ↓
2. ブラウザ: POST /api/chat
   {
     "session_id": "lego-001",
     "message": "赤いレゴの家を作って"
   }
   ↓
3. Flask Server:
   - セッション確認
   - NLU処理（意図抽出）
   - エンティティ抽出
   - JSONL に記録
   ↓
4. Session Manager:
   - セッション状態取得
   - Tool Call 生成
   ↓
5. Blender MCP:
   - 3D生成
   - STL出力
   - プレビュー生成
   ↓
6. Flask Server:
   - 結果を JSON で返却
   - JSONL に追記
   ↓
7. ブラウザ:
   - チャット表示
   - 3Dプレビュー表示
   - ダウンロードボタン表示
```

### 発注フロー（オプション）

```
1. 子供: "発注する" をクリック
   ↓
2. Flask Server:
   - 発注情報を JSONL に記録
   - 親にメール通知
   ↓
3. Go 処理エンジン:
   - 発注データを処理
   - 3Dプリンター業者に送信（オプション）
   - 進捗を追跡
   ↓
4. ブラウザ:
   - 発注ステータス表示
   - 配送情報表示
```

---

## 🛠️ 技術スタック

| 層 | 技術 | 言語 |
|---|---|---|
| **フロントエンド** | HTML5 + CSS3 + Vanilla JS | JavaScript |
| **3D表示** | Three.js / Babylon.js | JavaScript |
| **Web Server** | Flask | Python |
| **セッション管理** | Python | Python |
| **3D生成** | Blender MCP | Python |
| **データベース** | JSONL ファイル | - |
| **高速処理** | Go | Go |
| **発注フロー** | Go + JSONL | Go |

---

## 📈 実装ロードマップ

### Phase 1: MVP (1週間)
- [ ] Flask Web Server 基本実装
- [ ] HTML/CSS/JS フロントエンド
- [ ] チャット履歴 JSONL 保存
- [ ] Blender 連携テスト

### Phase 2: 機能拡張 (1週間)
- [ ] 3Dプレビュー実装 (Three.js)
- [ ] STL出力機能
- [ ] セッション永続化
- [ ] Go 処理エンジン基本実装

### Phase 3: 発注フロー (1週間)
- [ ] 発注フロー実装
- [ ] 親への通知機能
- [ ] 進捗追跡
- [ ] Go で JSONL 処理

### Phase 4: 最適化・デプロイ (1週間)
- [ ] パフォーマンス改善
- [ ] エラーハンドリング強化
- [ ] Docker化
- [ ] ドキュメント作成

---

## 🎨 UI/UX 要件

### ブラウザUI

```
┌─────────────────────────────────────────┐
│ 🏠 LegoDesigner                         │
├─────────────────────────────────────────┤
│                                         │
│ 👤 Child-001 | Session: lego-001       │
│                                         │
├─────────────────────────────────────────┤
│ 💬 チャット履歴                         │
│                                         │
│ [AI] 赤いレゴの家を作りました！        │
│ ┌─────────────────────────────────────┐ │
│ │ [3D Preview - Three.js]             │ │
│ │ (回転・拡大可能)                    │ │
│ └─────────────────────────────────────┘ │
│ [📥 ダウンロード] [💳 発注する]        │
│                                         │
│ [You] もっと大きく                     │
│                                         │
├─────────────────────────────────────────┤
│ 📝 入力欄                               │
│ ┌─────────────────────────────────────┐ │
│ │ 何を作りたい？                      │ │
│ └─────────────────────────────────────┘ │
│ [🎤 音声入力] [送信]                   │
└─────────────────────────────────────────┘
```

---

## 🔐 セキュリティ要件

1. **認証**: 子供用簡易認証（PIN / 保護者認証）
2. **データ保護**: チャット履歴の暗号化
3. **API認証**: JWT トークン
4. **レート制限**: DDoS対策
5. **ログ記録**: 監査ログ

---

## 📊 成功指標

| 指標 | 目標 |
|---|---|
| **API応答時間** | < 500ms |
| **3D生成時間** | < 2秒 |
| **チャット保存成功率** | > 99.9% |
| **モバイルUI読み込み** | < 1秒 |
| **セッション復帰時間** | < 100ms |

---

## 🚀 今後の拡張

- [ ] 音声入力対応
- [ ] AR プレビュー
- [ ] マルチプレイ（友達と共同設計）
- [ ] ランキング・シェア機能
- [ ] 3Dプリンター直接連携
- [ ] AI学習による推奨機能

---

## 📝 注記

**V1/V2 との互換性**
- セッション管理は完全に引き継ぎ
- Blender MCP は既存のまま使用
- 新規: Flask Backend + モバイルUI

**子供向け設計**
- シンプルなUI
- 分かりやすいメッセージ
- 楽しい3Dプレビュー
- 親の監視機能

**ML学習対応**
- 全チャット履歴を構造化
- 意図・エンティティ抽出済み
- JSONL形式でエクスポート可能
- バージョン管理対応
