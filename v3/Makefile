.PHONY: help install dev test build deploy clean

# V3 Makefile - LegoDesigner System

help:
	@echo "ğŸ  LegoDesigner V3 - Makefile"
	@echo ""
	@echo "Available commands:"
	@echo "  make install       - Install dependencies"
	@echo "  make dev           - Start development server"
	@echo "  make test          - Run tests"
	@echo "  make build         - Build for production"
	@echo "  make deploy        - Deploy to production"
	@echo "  make clean         - Clean up"
	@echo "  make lint          - Run linters"
	@echo "  make format        - Format code"
	@echo "  make docker-build  - Build Docker image"
	@echo "  make docker-run    - Run Docker container"
	@echo ""

# ========================================
# Installation
# ========================================

install:
	@echo "ğŸ“¦ Installing dependencies..."
	pip install -r requirements.txt
	go mod download
	@echo "âœ“ Dependencies installed"

install-dev:
	@echo "ğŸ“¦ Installing dev dependencies..."
	pip install -r requirements-dev.txt
	@echo "âœ“ Dev dependencies installed"

# ========================================
# Development
# ========================================

dev:
	@echo "ğŸš€ Starting development server..."
	python v3/app.py

dev-watch:
	@echo "ğŸ‘€ Starting development server with auto-reload..."
	python -m flask --app v3/app run --reload

# ========================================
# Testing
# ========================================

test:
	@echo "ğŸ§ª Running tests..."
	pytest v3/tests/ -v

test-coverage:
	@echo "ğŸ“Š Running tests with coverage..."
	pytest v3/tests/ --cov=v3 --cov-report=html

test-go:
	@echo "ğŸ§ª Running Go tests..."
	cd v3/go && go test ./...

# ========================================
# Building
# ========================================

build:
	@echo "ğŸ”¨ Building for production..."
	mkdir -p build
	cp -r v3/templates build/
	cp -r v3/static build/
	@echo "âœ“ Build complete"

build-go:
	@echo "ğŸ”¨ Building Go binaries..."
	cd v3/go && go build -o ../bin/lego-processor ./cmd/processor
	cd v3/go && go build -o ../bin/lego-order ./cmd/order
	@echo "âœ“ Go binaries built"

# ========================================
# Code Quality
# ========================================

lint:
	@echo "ğŸ” Running linters..."
	flake8 v3/ --max-line-length=120
	pylint v3/ --disable=all --enable=E,F
	cd v3/go && golangci-lint run ./...
	@echo "âœ“ Linting complete"

format:
	@echo "âœ¨ Formatting code..."
	black v3/
	isort v3/
	cd v3/go && gofmt -w .
	@echo "âœ“ Formatting complete"

# ========================================
# Docker
# ========================================

docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t lego-designer:v3 -f v3/Dockerfile .
	@echo "âœ“ Docker image built"

docker-run:
	@echo "ğŸ³ Running Docker container..."
	docker run -p 5000:5000 -v $(PWD)/data:/app/data lego-designer:v3
	@echo "âœ“ Docker container running"

docker-push:
	@echo "ğŸ“¤ Pushing Docker image..."
	docker tag lego-designer:v3 your-registry/lego-designer:v3
	docker push your-registry/lego-designer:v3
	@echo "âœ“ Docker image pushed"

# ========================================
# Deployment
# ========================================

deploy:
	@echo "ğŸš€ Deploying to production..."
	@echo "1. Building..."
	make build
	make build-go
	@echo "2. Running tests..."
	make test
	@echo "3. Building Docker image..."
	make docker-build
	@echo "âœ“ Deployment ready"

deploy-docker:
	@echo "ğŸš€ Deploying Docker container..."
	docker-compose -f v3/docker-compose.yml up -d
	@echo "âœ“ Docker deployment complete"

# ========================================
# Database
# ========================================

db-init:
	@echo "ğŸ—„ï¸  Initializing database..."
	mkdir -p data/sessions
	mkdir -p data/models
	mkdir -p data/orders
	@echo "âœ“ Database initialized"

db-clean:
	@echo "ğŸ—‘ï¸  Cleaning database..."
	rm -rf data/sessions/*
	rm -rf data/models/*
	rm -rf data/orders/*
	@echo "âœ“ Database cleaned"

# ========================================
# Data Processing
# ========================================

process-jsonl:
	@echo "âš™ï¸  Processing JSONL data..."
	cd v3/go && go run ./cmd/processor/main.go
	@echo "âœ“ JSONL processing complete"

export-ml-data:
	@echo "ğŸ“Š Exporting ML training data..."
	cd v3/go && go run ./cmd/ml-export/main.go
	@echo "âœ“ ML data exported"

# ========================================
# Cleanup
# ========================================

clean:
	@echo "ğŸ§¹ Cleaning up..."
	rm -rf build/
	rm -rf dist/
	rm -rf *.egg-info
	rm -rf .pytest_cache
	rm -rf .coverage
	rm -rf htmlcov/
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	cd v3/go && go clean
	@echo "âœ“ Cleanup complete"

clean-all: clean db-clean
	@echo "âœ“ Full cleanup complete"

# ========================================
# Documentation
# ========================================

docs:
	@echo "ğŸ“š Generating documentation..."
	mkdir -p docs
	@echo "âœ“ Documentation generated"

# ========================================
# Development Utilities
# ========================================

shell:
	@echo "ğŸš Starting Python shell..."
	python

shell-go:
	@echo "ğŸš Starting Go REPL..."
	cd v3/go && go run

logs:
	@echo "ğŸ“‹ Showing logs..."
	tail -f logs/app.log

logs-error:
	@echo "âŒ Showing error logs..."
	tail -f logs/error.log

# ========================================
# Status
# ========================================

status:
	@echo "ğŸ“Š System Status"
	@echo "==============="
	@echo "Flask Server: $(shell curl -s http://localhost:5000/health || echo 'Not running')"
	@echo "Session Manager: $(shell curl -s http://localhost:8765/health || echo 'Not running')"
	@echo "Blender: $(shell curl -s http://localhost:9876/health || echo 'Not running')"
	@echo ""

# ========================================
# Quick Start
# ========================================

quickstart: install db-init dev
	@echo "âœ“ Quick start complete"

# ========================================
# CI/CD
# ========================================

ci: lint test build
	@echo "âœ“ CI pipeline complete"

cd: build docker-build docker-push
	@echo "âœ“ CD pipeline complete"
